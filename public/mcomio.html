<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-COMIO | Secure Messaging Grid</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#66FCF1',
                        darkPanel: '#0F1115',
                        darkBase: '#050505'
                    },
                    fontFamily: { sans: ['Cairo', 'sans-serif'], mono: ['Rajdhani', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #fff; overflow: hidden; height: 100vh; font-family: 'Cairo', sans-serif; }
        .noise-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; opacity: 0.05; background: url('https://grainy-gradients.vercel.app/noise.svg'); }
        .cursor-dot, .cursor-circle { position: fixed; top: 0; left: 0; transform: translate(-50%, -50%); border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; }
        .cursor-dot { width: 6px; height: 6px; background: white; }
        .cursor-circle { width: 35px; height: 35px; border: 1px solid rgba(255,255,255,0.4); transition: width 0.3s, height 0.3s; }
        body.hovering .cursor-circle { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-color: transparent; }

        .glass-panel { background: rgba(15, 17, 21, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .active-chat { background: rgba(102, 252, 241, 0.08); border-right: 3px solid #66FCF1; }
        
        .message-in { background: rgba(255, 255, 255, 0.03); border-radius: 18px 18px 18px 4px; align-self: flex-start; }
        .message-out { background: rgba(102, 252, 241, 0.1); border-radius: 18px 18px 4px 18px; border: 1px solid rgba(102, 252, 241, 0.2); align-self: flex-end; }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="flex p-2 gap-2 h-screen overflow-hidden relative">

    <div class="cursor-dot"></div>
    <div class="cursor-circle"></div>
    <div class="noise-overlay"></div>

    <aside class="w-20 glass-panel rounded-3xl flex flex-col items-center py-8 gap-10 shrink-0">
        <div class="hover-target cursor-pointer" onclick="window.location.href='ivanovaworld.html'">
            <i class="fas fa-fingerprint text-brand text-2xl"></i>
        </div>
        
        <div class="flex flex-col gap-8 flex-1">
            <button title="Comio Feed" onclick="window.location.href='comio.html'" class="hover-target text-gray-500 hover:text-white transition">
                <i class="fas fa-rss text-xl"></i>
            </button>
            <button title="Messages" class="text-brand">
                <i class="fas fa-comment-dots text-xl"></i>
            </button>
        </div>

        <div class="flex flex-col gap-6">
            <img id="user-avatar" src="" class="w-10 h-10 rounded-full border border-brand/30 cursor-pointer hover-target" onclick="window.location.href='ivavers.html'">
        </div>
    </aside>

    <aside class="w-80 glass-panel rounded-3xl flex flex-col overflow-hidden shrink-0">
        <div class="p-6 border-b border-white/5">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-[Rajdhani] font-bold text-2xl tracking-widest">M-COMIO</h2>
                <i onclick="app.createNewGroup()" class="fas fa-plus-circle text-brand cursor-pointer hover-target" title="New Group"></i>
            </div>
            <div class="relative">
                <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 text-xs"></i>
                <input type="text" placeholder="Search grid..." class="w-full bg-black/40 border border-white/10 rounded-2xl py-3 pr-10 pl-4 text-[10px] focus:outline-none focus:border-brand transition">
            </div>
        </div>

        <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1">
            </div>
    </aside>

    <main class="flex-1 glass-panel rounded-3xl flex flex-col overflow-hidden relative">
        <header id="chat-header" class="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02] relative z-10 hidden">
            <div class="flex items-center gap-4">
                <img id="header-img" src="" class="w-12 h-12 rounded-2xl object-cover">
                <div>
                    <h2 id="header-name" class="text-lg font-bold">...</h2>
                    <div id="header-status" class="text-[10px] text-brand tracking-[0.2em] font-mono uppercase">Syncing...</div>
                </div>
            </div>
            <div class="flex gap-4">
                <button class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:text-brand transition hover-target"><i class="fas fa-shield-alt"></i></button>
            </div>
        </header>

        <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-center p-10">
            <i class="fas fa-comment-slash text-5xl text-white/5 mb-6"></i>
            <h3 class="text-xl font-bold font-[Rajdhani] tracking-widest">NO ACTIVE UPLINK</h3>
            <p class="text-xs text-gray-600 mt-2 max-w-xs">Select a node from the grid to initiate an encrypted transmission.</p>
        </div>

        <div id="messages-container" class="flex-1 p-8 overflow-y-auto flex flex-col gap-4 relative z-10 hidden">
            </div>

        <footer id="chat-footer" class="p-6 bg-white/[0.02] relative z-10 hidden">
            <div class="bg-black/40 rounded-2xl p-2 flex items-center gap-4 px-6 border border-white/10">
                <input id="msg-input" type="text" placeholder="Secure transmission..." class="flex-1 bg-transparent border-none text-sm focus:ring-0 placeholder-gray-700 hover-target">
                <button onclick="app.sendMessage()" class="w-10 h-10 bg-brand rounded-xl flex items-center justify-center text-black hover:bg-white transition hover-target">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </footer>
    </main>

    <script>
        const app = {
            supabase: null,
            currentUser: null,
            activeTarget: null, // {id, type: 'mes' | 'grmes'}

            init: async () => {
                app.supabase = supabase.createClient('https://yubvsehgmnudhcqwajae.supabase.co', 'sb_publishable_jx6I4sjazjPPYFYldG_ZtA_MQc172DC');
                const { data: { session } } = await app.supabase.auth.getSession();
                
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                const { data: profile } = await app.supabase.from('profiles').select('*').eq('id', session.user.id).single();
                app.currentUser = profile;
                document.getElementById('user-avatar').src = profile.avatar_url;

                app.loadChatList();
                app.handleRouting();
                app.subscribeToMessages();
            },

            handleRouting: () => {
                const url = window.location.href;
                if (url.includes('mes?=')) {
                    const idUser = url.split('mes?=')[1].replace('/', '');
                    app.openPrivateChat(idUser);
                } else if (url.includes('grmes?=')) {
                    const idChat = url.split('grmes?=')[1].replace('/', '');
                    app.openGroupChat(idChat);
                }
            },

            loadChatList: async () => {
                // جلب المستخدمين الآخرين كمثال لجهات الاتصال
                const { data: profiles } = await app.supabase.from('profiles').select('*').neq('id', app.currentUser.id).limit(10);
                const list = document.getElementById('chat-list');
                
                list.innerHTML = profiles.map(p => `
                    <div onclick="window.location.href='mcomio.html/mes?=${p.iduser}/'" class="p-4 rounded-2xl flex gap-4 cursor-pointer hover:bg-white/5 transition hover-target ${app.activeTarget?.id === p.iduser ? 'active-chat' : ''}">
                        <img src="${p.avatar_url}" class="w-12 h-12 rounded-2xl object-cover">
                        <div class="flex-1 min-w-0 text-xs">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-white">${p.username}</span>
                            </div>
                            <p class="text-gray-500 truncate">ID: ${p.iduser}</p>
                        </div>
                    </div>
                `).join('');
            },

            openPrivateChat: async (iduser) => {
                app.activeTarget = { id: iduser, type: 'mes' };
                app.showChatUI();

                const { data: targetProfile } = await app.supabase.from('profiles').select('*').eq('iduser', iduser).single();
                if (targetProfile) {
                    document.getElementById('header-name').innerText = targetProfile.username;
                    document.getElementById('header-img').src = targetProfile.avatar_url;
                    document.getElementById('header-status').innerText = `NODE ID: ${targetProfile.iduser}`;
                    app.loadMessages(targetProfile.id);
                }
            },

            showChatUI: () => {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('chat-header').classList.remove('hidden');
                document.getElementById('messages-container').classList.remove('hidden');
                document.getElementById('chat-footer').classList.remove('hidden');
            },

            loadMessages: async (targetUuid) => {
                const { data: msgs } = await app.supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${app.currentUser.id},receiver_id.eq.${targetUuid}),and(sender_id.eq.${targetUuid},receiver_id.eq.${app.currentUser.id})`)
                    .order('created_at', { ascending: true });

                const container = document.getElementById('messages-container');
                container.innerHTML = msgs.map(m => `
                    <div class="p-4 max-w-[75%] text-sm ${m.sender_id === app.currentUser.id ? 'message-out' : 'message-in'}">
                        ${m.message_text}
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            },

            sendMessage: async () => {
                const input = document.getElementById('msg-input');
                if (!input.value || !app.activeTarget) return;

                if (app.activeTarget.type === 'mes') {
                    const { data: target } = await app.supabase.from('profiles').select('id').eq('iduser', app.activeTarget.id).single();
                    await app.supabase.from('messages').insert({
                        sender_id: app.currentUser.id,
                        receiver_id: target.id,
                        message_text: input.value
                    });
                }
                input.value = '';
            },

            subscribeToMessages: () => {
                app.supabase.channel('public:messages')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        app.handleRouting(); // إعادة تحميل الرسائل عند وصول جديد
                    }).subscribe();
            },

            createNewGroup: () => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let idchat = '';
                for (let i = 0; i < 21; i++) idchat += chars.charAt(Math.floor(Math.random() * chars.length));
                alert("New Group ID Generated: " + idchat);
                window.location.href = `mcomio.html/grmes?=${idchat}/`;
            }
        };

        // الماوس
        const cursorDot = document.querySelector('.cursor-dot');
        const cursorCircle = document.querySelector('.cursor-circle');
        document.addEventListener('mousemove', (e) => {
            cursorDot.style.left = `${e.clientX}px`; cursorDot.style.top = `${e.clientY}px`;
            cursorCircle.animate({ left: `${e.clientX}px`, top: `${e.clientY}px` }, { duration: 500, fill: "forwards" });
        });

        window.onload = app.init;
    </script>
</body>
</html>
